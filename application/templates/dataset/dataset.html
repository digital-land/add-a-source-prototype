{% extends 'layouts/base.html' %}

{% block beforeContent %}
<div class="govuk-breadcrumbs">
  <ol class="govuk-breadcrumbs__list">
    <li class="govuk-breadcrumbs__list-item">
      <a class="govuk-breadcrumbs__link" href="{{ url_for('base.index') }}">Home</a>
    </li>
    <li class="govuk-breadcrumbs__list-item">
      <a class="govuk-breadcrumbs__link" href="{{ url_for('dataset.index') }}">Datasets</a>
    </li>
    <li class="govuk-breadcrumbs__list-item">
      {{dataset.name}}
    </li>
  </ol>
</div>
{% endblock beforeContent %}

{% block content %}

<span class="govuk-caption-xl">Dataset</span>
<h1 class="govuk-heading-xl">{{dataset.name}}</h1>

<p class="govuk-body">Typology: <span class="govuk-!-font-weight-bold">{{ dataset.typology.name }}</span></p>

<p class="govuk-body">This dataset is the yield of the {{ dataset.collection.name }} pipeline. The pipeline has been configured to collect, process and yield data that matches the <a href="{{ url_for('schema.schema', dataset_id=dataset.dataset) }}" class="govuk-link">{{ dataset.name }} schema</a>.</p>

<h2 class="govuk-heading-l">Pipeline rules</h2>

{% macro ruleTableHead(params) %}
<thead class="govuk-table__head">
  <tr class="govuk-table__row">
    {% for field in params.fields  %}
    <th scope="col" class="govuk-table__header">{{ field.name }}</th>
    {% endfor %}
  </tr>
</thead>
{% endmacro %}

<div class="govuk-accordion" data-module="govuk-accordion" id="accordion-default">

  {% for rule_type_name in specification_pipelines -%}
  {% set rule_type_tablename = rule_type_name|replace("-", "_") %}
  <div class="govuk-accordion__section">
    <div class="govuk-accordion__section-header">
      <h2 class="govuk-accordion__section-heading">
        <span class="govuk-accordion__section-button" id="accordion-default-heading-1">
          {{ pipeline[rule_type_tablename]|length }} {{ rule_type_name }} rules
        </span>
      </h2>
    </div>
    <div id="accordion-default-content-1" class="govuk-accordion__section-content" aria-labelledby="accordion-default-heading-1">
      <p class='govuk-body'>{{ specification_pipelines[rule_type_name].description }}</p>
      {% if pipeline[rule_type_tablename]|length > 0 %}
      <table class="govuk-table">
        {{ ruleTableHead({ "fields": specification_pipelines[rule_type_name].fields }) }}
        {% set rows = pipeline[rule_type_tablename]|length if pipeline[rule_type_tablename]|length < 6 else 5 %}
        <tbody class="govuk-table__body">
        {% for n in range(rows) %}
          {% set rule = pipeline[rule_type_tablename][n] %}
          <tr class="govuk-table__row">
          {%- for field in specification_pipelines[rule_type_name].fields %}
            <td class="govuk-table__cell">{{ rule[field.field] }}</td>
          {% endfor -%}
          </tr>
        {% endfor %}
        </tbody>
      </table>
      {% endif %}
    </div>
  </div>
  {%- endfor %}

</div>

<h2 class="govuk-heading-l">Sources</h2>

<a class="govuk-button govuk-button--secondary" data-module="govuk-button" href="{{ url_for('source.add', pipeline=pipeline.id) }}">
  + add new source
</a>

<ul class="govuk-list govuk-list--bullet">
{% for source in pipeline.sources %}
  <li><a class="govuk-link" href="{{ url_for('source.source', source_hash=source.source)}}">{{ source.source }}</a></li>
{% endfor %}
</ul>

{% endblock content %}
